name: Auto Version Bump

on:
  push:
    branches:
      - dev

permissions:
  contents: write
  pull-requests: write

jobs:
  update-version:
    # ProteÃ§Ãµes anti-loop
    if: |
      github.actor != 'github-actions[bot]' &&
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, 'chore: bump version')

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Evita rebump se system.json jÃ¡ foi modificado
      - name: Check changed files
        id: changed
        uses: tj-actions/changed-files@v44

      - name: Stop if system.json already changed
        if: contains(steps.changed.outputs.modified_files, 'system.json')
        run: |
          echo "system.json already modified in this push. Skipping bump."
          exit 0

      - name: Bump version
        id: version
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'system.json';

            const content = fs.readFileSync(path, 'utf8');
            const json = JSON.parse(content);

            if (!json.version) return;

            let [major=0, minor=0, patch=0] =
              json.version.split('.').map(Number);

            patch++;

            if (patch >= 10) {
              patch = 0;
              minor++;
            }

            if (minor >= 10) {
              minor = 0;
              major++;
            }

            const newVersion = `${major}.${minor}.${patch}`;
            json.version = newVersion;

            fs.writeFileSync(path, JSON.stringify(json, null, 2) + '\n');

            core.setOutput('new_version', newVersion);

      - name: Create PR
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: bump version to ${{ steps.version.outputs.new_version }} [skip ci]"
          title: "chore: bump version to ${{ steps.version.outputs.new_version }}"
          body: "ðŸ¤– Automated version bump"
          branch: auto/version-bump
          base: dev
          delete-branch: true

      # Auto-merge da PR criada
      - name: Enable auto-merge
        if: steps.cpr.outputs.pull-request-number
        run: |
          gh pr merge ${{ steps.cpr.outputs.pull-request-number }} \
            --squash --auto
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
