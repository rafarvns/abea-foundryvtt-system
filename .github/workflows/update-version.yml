name: Update Version on Dev

on:
  push:
    branches:
      - dev

permissions:
  contents: write
  pull-requests: write

jobs:
  update-version:
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update Version Logic
        id: version
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'system.json';

            try {
              const content = fs.readFileSync(path, 'utf8');
              const json = JSON.parse(content);

              if (!json.version) {
                console.log("No version field found");
                return;
              }

              let versionParts = json.version.split('.').map(Number);

              while (versionParts.length < 3) {
                versionParts.push(0);
              }

              let [major, minor, patch] = versionParts;

              patch += 1;

              if (patch >= 10) {
                patch = 0;
                minor += 1;
              }

              if (minor >= 10) {
                minor = 0;
                major += 1;
              }

              const newVersion = `${major}.${minor}.${patch}`;
              json.version = newVersion;

              fs.writeFileSync(path, JSON.stringify(json, null, 2) + '\n');

              console.log(`Updated version to ${newVersion}`);
              core.setOutput('new_version', newVersion);

            } catch (error) {
              core.setFailed(error.message);
            }

      - name: Create Pull Request
        if: steps.version.outputs.new_version
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Auto-update version to ${{ steps.version.outputs.new_version }}"
          title: "Auto version bump to ${{ steps.version.outputs.new_version }}"
          body: "ðŸ¤– Automated version bump"
          branch: auto/version-bump
          base: dev
          delete-branch: true
